name: Update API Specs

on:
  schedule:
    # Run weekly on Monday at 6am UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      minor_version:
        description: 'Filter by minor version (e.g., 2.4). Leave empty for all.'
        required: false
        default: ''
      force:
        description: 'Force re-check all versions'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync:
    name: Sync Specs
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.sync.outputs.changed }}
      has_new_baselines: ${{ steps.baselines.outputs.has_new }}
      new_baselines: ${{ steps.baselines.outputs.new_baselines }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build tools
        run: make build

      - name: Run spec-sync
        id: sync
        run: |
          ARGS=""
          if [ -n "${{ github.event.inputs.minor_version }}" ]; then
            ARGS="$ARGS --minor ${{ github.event.inputs.minor_version }}"
          fi
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            ARGS="$ARGS --force"
          fi

          echo "Running: ./bin/spec-sync $ARGS"
          ./bin/spec-sync $ARGS 2>&1 | tee sync-output.txt

          if git diff --quiet manifest.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to manifest"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Manifest updated"
          fi

      - name: Check for new baselines
        id: baselines
        if: steps.sync.outputs.changed == 'true'
        run: |
          git show HEAD:manifest.json 2>/dev/null | jq -r '.baselines[]' | sort > /tmp/old-baselines.txt || touch /tmp/old-baselines.txt
          jq -r '.baselines[]' manifest.json | sort > /tmp/new-baselines.txt

          NEW_BASELINES=$(comm -13 /tmp/old-baselines.txt /tmp/new-baselines.txt | tr '\n' ' ')

          if [ -n "$NEW_BASELINES" ]; then
            echo "new_baselines=$NEW_BASELINES" >> $GITHUB_OUTPUT
            echo "has_new=true" >> $GITHUB_OUTPUT
            echo "New baselines: $NEW_BASELINES"
          else
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "No new baselines (only version mappings updated)"
          fi

      - name: Upload manifest
        if: steps.sync.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: manifest.json

      - name: Upload specs
        if: steps.sync.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: specs
          path: specs/

  generate:
    name: Generate Types
    needs: sync
    if: needs.sync.outputs.changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: manifest

      - name: Download specs
        uses: actions/download-artifact@v4
        with:
          name: specs
          path: specs/

      - name: Build tools
        run: make build

      - name: Generate baseline types
        run: ./scripts/generate-baselines.sh

      - name: Generate union descriptions
        run: |
          ./bin/description-union-gen \
            -manifest manifest.json \
            -output generated/go/union \
            -generated generated/go

      - name: Cleanup non-baseline specs
        run: ./bin/spec-sync --cleanup

      - name: Format generated code
        run: go fmt ./generated/go/...

      - name: Upload generated code
        uses: actions/upload-artifact@v4
        with:
          name: generated
          path: |
            generated/
            specs/
            manifest.json

  verify:
    name: Verify Build
    needs: [sync, generate]
    if: needs.sync.outputs.changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated

      - name: Verify build
        run: |
          go build -tags "checkmk_all" ./generated/go/...
          echo "âœ… Build successful!"

  create-pr:
    name: Create Pull Request
    needs: [sync, generate, verify]
    if: needs.sync.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated

      - name: Create summary
        run: |
          echo "## Spec Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL=$(jq '.mapping | length' manifest.json)
          BASELINES=$(jq '.baselines | length' manifest.json)

          echo "- **Total versions:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Baselines:** $BASELINES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.sync.outputs.has_new_baselines }}" = "true" ]; then
            echo "### New Baselines" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.sync.outputs.new_baselines }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update API specs"
          title: "chore: Update CheckMK API specs"
          body: |
            ## Automated Spec Update

            This PR was automatically generated by the spec-sync workflow.

            ### Changes
            - Updated `manifest.json` with new version mappings
            ${{ needs.sync.outputs.has_new_baselines == 'true' && '- Generated types for new baselines' || '' }}

            ### New Baselines
            ```
            ${{ needs.sync.outputs.new_baselines || 'None (only version mappings updated)' }}
            ```

            ---
            *Generated by [spec-sync workflow](.github/workflows/update-specs.yml)*
          branch: auto-update-specs
          delete-branch: true
          labels: |
            automated
            specs

  no-changes:
    name: No Changes
    needs: sync
    if: needs.sync.outputs.changed != 'true'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No new versions found. Nothing to update."
